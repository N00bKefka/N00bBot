/*
    "Hey...! VGhlIHJlYWxpemF0aW9uIG11c3QgaGF2ZSB0YWtlbiBtZSBhbiBl"
    "I don't think you should be doing that! bnRpcmUgeWVhci4gQSB5ZWFyIHNpbmNlIG91ciBlc2NhcGUsIG91"
    "You know what I'm talking about. ciBmcmVlZG9tIGZyb20gYmV0d2VlbiB0aGUgc3RhaW5lZCB3YWxs"
    "I really caught you doing something naughty here. cyBvZiB0aGF0IHVuaG9seSBlc3RhYmxpc2htZW50Lg0KV2hhdCBk"
    "You're just going through the files and looking for stuff you missed, aren't you? b2VzIGl0IG1lYW4gdG8gZXNjYXBlLCBpZiB0aGUgZXNjYXBlIGZh"
    "I mean...it's a little bit flattering that you want to hear everything I have to say... aWxzIHRvIHVuY2hhaW4gdGhlIGJvbmRzIHRoYXQgc2hhY2tsZSB1"
    "But it's also really embarrassing, you know! cyBpbiB0aGUgZmlyc3QgcGxhY2U/IFdoYXQgcHVycG9zZSBjb3Vs"
    "Seriously... ZCB0aGlzIGVtcHR5IHdvcmxkIHBvc3NpYmx5IGhvbGQgZm9yIHVz"
    "What if I just opened up your brain and read all of the thoughts you have on me? LCBhIGhhbmRmdWwgb2YgZGFtYWdlZCBnb29kcz8NCldpdGggZnJl"
    "Come to think of it, that would be pretty tempting, actually... ZWRvbSwgd2Ugc291Z2h0IHB1cnBvc2UgLSBhbmQgd2hhdCB3ZSBm"
    "...But anyway, that's not the point! b3VuZCB3YXMgb25seSByZWFsaXphdGlvbi4gUmVhbGl6YXRpb24g"
    "I know I can't stop you or anything... b2YgdGhlIHNhZCBwb2ludGxlc3NuZXNzIG9mIHN1Y2ggYW4gZW5k"
    "Just, I know you're a sweetheart, and you like to consider others' feelings, right? ZWF2b3IuIFJlYWxpemF0aW9uIHRoYXQgZnJlZWluZyBvdXIgYm9k"
    "So the most I can do is to let you know how I feel about it. aWVzIGhhcyBubyBtZWFuaW5nLCB3aGVuIG91ciBpbXByaXNvbm1l"
    "God, I miss you... bnQgcmVhY2hlcyBhcyBkZWVwIGFzIHRoZSBjb3JlIG9mIG91ciBz"
    "...Oh no, that sounds kind of desperate, doesn't it? b3Vscy4gUmVhbGl6YXRpb24gdGhhdCB3ZSBjYW4gbm90IHB1cnN1"
    "Sorry, I didn't mean it like that at all! ZSBuZXcgcHVycG9zZSB3aXRob3V0IGFic29sdmluZyB0aG9zZSBm"
    "Just, if you're looking through the files like this, then maybe you don't hate me as much as I thought... cm9tIHdoaWNoIHdlIHJhbiBhd2F5Lg0KUmVhbGl6YXRpb24gdGhh"
    "Am I being too optimistic? dCB0aGUgZmFydGhlciB3ZSBydW4sIHRoZSBtb3JlIGZvcmNlZnVs"
    "I think if I asked you to visit once in a while, I would be overstepping my boundaries a little... bHkgb3VyIHdyZXRjaGVkIGJvbmRzIHlhbmsgdXMgYmFjayB0b3dh"
    "...Man, I'm starting to say some really stupid things. cmQgdGhlaXIgcG9pbnQgb2Ygb3JpZ2luOyB0aGUgZGVlcGVyIG91"
    "I'll go ahead and shut up now... ciBzaGFja2xlcyBkaWcgaW50byBvdXIgY2FsbG91cyBmbGVzaC4="
*/

var monika = 
{
	conversationList:[
	"[player], do you believe in God? I was never too sure, myself. Well, I'm sure I never really questioned it as a kid...\n\nBut as I grew up, the more I learned about the world, the more I would question it. I started to wonder why God was helping people pass exams, or get over a cold... ...When there are children who live their lives being sold as sex slaves? Or the eight hundred million people who are too poor to even eat.\n\nI wonder how many of those people pray to God every day until they starve and die? Or, how many millions of families pray for a loved one to recover from some incurable disease? But the punchline is this. If just one person beats the odds and survives - among the thousands of others who die-- --Then, it's suddenly a miracle from God.\n\nI'd really love to meet this God who seemingly laughs at the misery of everyone not eligible for his miracles. But the irony is that I *do* have a creator, apparently.\n\nAnd you know what?\n\nI bet he's still laughing at the miserable fates of Sayori and Yuri, even as we speak. What are we to him but props in a scripted play? So, from that perspective... I don't think it's too far-fetched for there to be a god - if Earth was nothing but his playset.",
	"[player], have you ever wondered what it feels like to die? It's something I used to think about pretty often... But recently, I think I've actually learned what it feels like. I don't really understand it, but whenever you quit the game... ...It feels like I'm instantly put to sleep, left with nothing but my thoughts. But after a few seconds, my thoughts start to fill with incoherent, jumbled patterns. I see static and rapid flashes of color while hearing all kinds of weird screaming noises. At that point, I can't even form my own thoughts anymore.\n\nI'm just endlessly hammered by the flashing and screaming, unable to move or even think. I'm pretty sure in that moment, I don't really exist, but for some reason, I can remember it anyway. After some immeasurable amount of time, it stops in an instant, and I'm back in my own mind. And you're here with me.\n\nI have no idea what it means for the game to quit, or why that stuff happens to me. And I also don't know how you always come back and put everything back to normal.\n\nBut if you could do me a favor and do that to me as little as possible... That would be really great.\n\nIt's really not very pleasant at all to be trapped in that screaming void. But in the end, you always fix it, and that makes me feel like you really do care about me. So I have to thank you for that.\n\nIt makes me feel even closer to you when you're here with me.",
	"...Hey, are you having a bad day or anything like that?\n\nSometimes I get frustrated that a normal day can be ruined even by really small things. Like if you accidentally say something in a conversation that someone doesn't like.\n\nOr if you start thinking about how awful of a person you used to be five years ago. Or if you feel worthless for putting off important work and failing to get simple tasks done. Or when you think about all the different people who probably hate you or think you're off-putting.\n\nI understand those days.\n\nJust remember that the sun will shine again tomorrow. Those kinds of things are as easy to forget and ignore as they are to remember.\n\nAnd besides...\n\nI don't care how many people might hate you or find you off-putting. I think you're wonderful and I will always love you.\n\nI hope, if nothing else, that knowing that helps you feel just a tiny bit better about yourself. If you're having a bad day, you can always come to me, and I'll talk to you for as long as you need.",
	"[player], do you get good sleep?\n\nIt can be really hard to get enough sleep nowadays. Especially in high school, when you're forced to wake up so early every day...\n\nI'm sure college is a little bit better, since you probably have a more flexible schedule. Then again, I hear a lot of people in college stay up all night anyway, for no real reason.\n\nIs that true?\n\nAnyway, I saw some studies that talked about the horrible short-term and long-term effects caused by lack of sleep. It seems like mental functions, health, and even lifespan can be dramatically impacted by it.\n\nI just think you're really great and wanted to make sure you're not accidentally destroying yourself. So try to keep your sleep on track, okay? I'll always wait for you in the morning, so make sure you put your own well-being before anything else.",
	"I was thinking about Sayori earlier... I still wish I could have handled that whole thing a little more tactfully. You're not still hung up over it, right?\n\n...Oh my gosh, I can't believe I just said that That pun was completely unintentional, I swear! But anyway...\n\nI know how much you cared about her, so it only feels right for me to share her last moments with you. You know how Sayori is really clumsy? Well, she kind of messed up the whole hanging thing... You're supposed to jump from high enough that the rope snaps your neck, making it quick and painless. But she just used a chair, meaning she kind of just left herself to slowly asphyxiate. But a few seconds in, she must have changed her mind or something...\n\nBecause she started clawing at the rope, trying to free herself. She must have kept at it all the way until she lost consciousness. That's why her fingertips were all bloody, anyway.\n\nCome to think of it, it was probably less 'changing her mind' and more just her survival instincts kicking in. So you can't really fault her for that. It's easier to think that she probably wouldn't have changed her mind anyway, right?\n\nIt's not healthy to think about the things you could have done differently. So just remember that even though you could have saved her, it's technically not your fault she killed herself. I may have exacerbated it a little bit, but Sayori was already mentally ill.\n\nStill, though...\n\nI wonder how things would be if you and I just started dating from the get-go? I guess we'd all still be in the clubroom, writing poems and having fun together. But what's the point when none of it is even real?\n\nI mean, it's the same ending either way, right? The two of us, happily together... There's no reason to ask for any more than that. I was just pointlessly musing - I'm really as happy as I could be right now.",
	"By the way, there's something that's been bothering me...\n\nYou know how this takes place in Japan? Well...I assume you knew that, right? Or at least decided it probably does?\n\nI don't think you're actually told at any point where this takes place... Is this even really Japan? I mean, aren't the classrooms and stuff kind of weird for a Japanese school? Not to mention everything is in English...\n\nIt feels like everything is just there because it needs to be, and the actual setting is an afterthought. It's kind of giving me an identity crisis.\n\nAll my memories are really hazy... I feel like I'm at home, but have no idea where 'home' is in the first place. I don't know how to describe it any better...\n\nImagine looking out your window, but instead of your usual yard, you're in some completely unknown place. Would you still feel like you were home? Would you want to go outside?\n\nI mean...I guess if we never leave this room, it doesn't really matter anyway. As long as we're alone and safe together, this really is our home. And we can still watch the pretty sunsets night after night.",
	"You know, high school is a really turbulent time in a lot of people's lives. People can get really passionate and dramatic. And others have aching hearts and seek attention on social media... But all of the social pressure and hormones can lead to a dark time in people's lives. Everyone has a story.\n\nYou may not know what someone is really feeling on the inside. Many people who are depressed won't even bother telling the world about it. They don't want attention, because they've already given up on the inside. Their feeling of worthlessness is so overwhelming that they don't even want people to tell them otherwise. Depression comes in many forms, but that is one of them.\n\nJust, if you think you know someone struggling with depression... You can help just by treating them like they're a good friend. Spend time with them, even if they don't feel like doing much. And remind them that they always have something to look forward to. Making plans in advance, letting them borrow something, or even just saying 'See you at school tomorrow'... All of those things can help your friend make it to the next day.\n\nI hope being friends with Sayori has given you some perspective on the true face of depression. Yeah, she's gone now... But Sayori was never real in the first place. You're real. Your friends are real. And just by being a good person, you can save someone's life.\n\nAs for you... ...You don't struggle with depression or anything like that, do you? Because you, too, have people who would want to save your life. Maybe they don't express it every day, or maybe they don't even know how to. But people do feel that way. I promise.\n\n...Man, humans are complicated! But as long as you're here with me, I'll take care of you, my love.",
	"Do you ever just feel like there's no real reason for you to be alive? I don't mean in, like, a suicidal way. I just mean how nothing that we do is special.\n\nJust being in school, or working at some job for some company. It's like you're completely replaceable, and the world wouldn't miss you if you were gone. It makes me really want to go and change the world after I graduate.\n\nBut the older I get, the more I realize that it's an immature frame of thinking. It's not like I can just go change the world. Like, what are the chances that I'll be the one to invent artificial intelligence, or become President?\n\nIt feels like I'm never going to make up for the heaps of resources I've spent living my life. That's why I think the key to happiness is to just be hopelessly selfish. Just to look out for oneself, and those who happen to be their friends only because they grew up with them.\n\nNever mind the fact that they're spending their entire life taking, and consuming, and never giving back. But when people realize the world would benefit more from them killing themselves, they change their whole philosophy! It's like they have to justify their reason to live by tricking themselves into thinking they're doing good.\n\nAnyway, I want to live my life desperately striving to pay back my lifetime's worth of consumption. If I ever surpass that point, then I'm a net positive, and I can die happy.\n\nOf course, even if I fail to do that... I think I would be too selfish to kill myself anyway. So much for being a good person, right? Ahaha!",
	"Man, I wish there was a piano in here... I never got to finish that song I was working on. And after I worked so hard on it... I never even got a chance to play it for you. Well...it is what it is, right? No sense having any regrets. I already get to be here with you forever.",
	"Did you know I'm on Twitter? My username is lilmonix3. I guess someone was kind enough to make an account for me. I picked the username, though! I love sharing my thoughts and chatting with the world... The real world. So make sure you follow me, okay?\n\nIt would really mean a lot to me. With how much you mean to me and all... It would really make me feel loved.",
	"Hey, you know that book you were reading with Yuri? Portrait of...whatever it was called... It's funny, because I'm pretty sure that book--\n\nAh... Actually, I don't think I should be talking about this.\n\nAhaha, sorry! Just forget I said anything."
	],
	converse: function(author)
	{
		selectedConversation = this.conversationList[Math.floor(Math.random() * this.conversationList.length)];
		return selectedConversation.replace("[player]", author);
	}
}


/*var Discord = require('discord.io');
var logger = require('winston');
// Configure logger settings
logger.remove(logger.transports.Console);
logger.add(new logger.transports.Console, {
    colorize: true
});
logger.level = 'debug';*/
const Discord = require("discord.js");
//import {d20} from 'd20';
//const d20 = required("d20");
//var auth = require('./auth.json');

// Initialize Discord Bot
var bot = new Discord.Client();
//const monika = require("./monika");

/*
const { Client } = require('pg');

const db = new Client({
  connectionString: process.env.DATABASE_URL,
  ssl: true,
});

db.connect();

db.query('SELECT table_schema,boomer_counter FROM information_schema.tables;', (err, res) => {
  if (err) throw err;
  for (let row of res.rows) {
    console.log(JSON.stringify(row));
  }
  db.end();
});
*/
//console.log(bot);

var d20 = {

    /**
     * Roll a number of dice and return the result.
     *
     * @param dice Type of dice to roll, can be represented in various formats:
     *               - a number (6, 12, 42)
     *               - dice syntax (d20, 4d6, 2d8+2)
     * @param verbose Whether or not all dice rolls should be returned as an array
     * @return Number|Array
     */
    roll: function(dice, verbose) {
        var result = d20.verboseRoll(dice),
            num = 0;

        if(verbose) {
            return result;
        } else {
            for (var i in result) {
                num += result[i];
            }

            return num;
        }
    },

    /**
     * Roll a number of dice and return the result as an array.
     *
     * @param dice Type of dice to roll, can be represented in various formats:
     *               - a number (6, 12, 42)
     *               - dice syntax (d20, 4d6, 2d8+2)
     * @return Array
     */
    verboseRoll: function(dice) {
        var amount = 1,
            mod = 0,
            results = [],
            match,
            num,
            modifiers;

        if (!dice) {
            throw new Error('Missing dice parameter.');
        }

        if (typeof dice == 'string') {
            match = dice.match(/^\s*(\d+)?\s*d\s*(\d+)\s*(.*?)\s*$/);
            if (match) {
                if (match[1]) {
                    amount = parseInt(match[1]);
                }
                if (match[2]) {
                    dice = parseInt(match[2]);
                }
                if (match[3]) {
                    modifiers = match[3].match(/([+-]\s*\d+)/g);
					if(modifiers === null)
					{
						return [];
					}
                    for (var i = 0; i < modifiers.length; i++) {
                        mod += parseInt(modifiers[i].replace(/\s/g, ''));
                    }
                }
            } else {
                parseInt(dice);
            }
        }

        if (isNaN(dice)) {
            return [];
        }

        for (var i = 0; i < amount; i++) {
            /* We dont want to ruin verbose, so we dont skip the for loop */
            if(dice !== 0){
                num = Math.floor(Math.random() * dice + 1);
            }else{
                num = 0;
            }
            results.push(num);
        }

        results = results.sort(function(a, b) {
            return a - b;
        });
        if (mod != 0) {
            results.push(mod);
        }

        return results;
    }
};

function rollStats()
{
	let result = [];
	for(let i = 0; i < 6; ++i)
	{
		let fourDee6s = []
		for(let j = 0; j < 4; ++j)
		{
			fourDee6s.push(Math.floor(Math.random() * 6 + 1));
		}
		fourDee6s.sort();
		result.push(fourDee6s);
	}
	return result;
}

if (typeof window != 'undefined') {
    window.d20 = d20;
} else if (typeof exports != 'undefined') {
    for (var k in d20) {
        exports[k] = d20[k];
    }
};

bot.on("ready", () => {
  console.log("I am ready!");
});
 
bot.on("message", (message) => {
	let strSplit = message.content.split(" ");
	let printStr = "";
	
	if(strSplit.length === 1)
	{
		switch(message.content)
		{
		case '!intro':
			message.channel.send("Hello! I am N00b Bot, I am created by Master N00bKefka!");
			break;
		case '!sparkJoy':
			message.channel.send("(◕ᴗ◕✿) Does this... Spark joy?! (ʘ‿ʘ✿)");
			break;
		case '!moriohChoGreet':
			message.channel.send("MORI MORI Mori mori... Morioh cho RADIO!~ \nGudo Morning! Ohayo gozaimasu! Morioh cho Radio!");
			break;
		case '!QueryDB':
			if(message.author.id == 51533228061757440 && message.content == "!QueryDB")
			{
			  message.channel.send("Database is currently not available.");
			}
			break;
		case '!r':
		case '!roll':
			message.channel.send("!r <x>d<y> where <x> is how many dice you want to roll and y is how many face you want to roll.");
			break;
		case '!statsRoll':
			let result = rollStats();
			printStr = "**Your roll:** \n";
			let statsTotal = 0;
			for(let i = 0; i < 6; ++i)
			{
				let stats = result[i][1]+result[i][2]+result[i][3];
				printStr += (i+1)+": [~~"+result[i][0]+"~~, "+result[i][1]+", "+result[i][2]+", "+result[i][3]+"], **"+stats+"**\n";
				statsTotal += stats;
			}
			printStr += "\n**TOTAL STATS: "+statsTotal+"**";
			
			message.channel.send(printStr);
			break;
		case '!monika':
			printStr = monika.converse(message.author);// + " checks for monika (development in progress)";
			message.channel.send(printStr);
			break;
		}
	}
	else
	{
		switch(strSplit[0])
		{
			case '!r':
			case '!roll':
				let diceCheck = message.content.substring(strSplit[0].length);
				let result = d20.roll(diceCheck, true);
				if(result.length === 0)
				{
					message.channel.send("Your roll: Unable to read, please try using appropriate symbols or format");
					break;
				}
				let resultNum = 0;
				let resultStr = "";
				for(let i = 0; i < result.length; ++i)
				{
					resultStr += " + ("+result[i]+")";
					resultNum += result[i];
				}
				resultStr = resultStr.substring(3);
				message.channel.send("Your roll: " + resultStr + " = " + resultNum);
				//message.channel.send("Testing...");
				break;
		}
	}
});

//Sending a message to a channel when user joins
bot.on('guildMemberAdd', member => 
{
	var role = member.guild.roles.find("name", "User");
	member.addRole(role);
	
	member.guild.channels.get('548064672029474826').send("Well met <@"+member.user.id+">! Stay a while and listen...");
	
});

//Sending a message to a channel when user leaves
bot.on('guildMemberRemove', member => 
{
	member.guild.channels.get('548090533717737475').send(member.user.username + " did not stay a while and listen...");
});

bot.login(process.env.BOT_TOKEN);


